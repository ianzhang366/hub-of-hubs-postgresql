---
- name: delete tables
  tags: tables
  postgresql_table:
    name: "{{ table_name }}"
    db: "{{ hoh_db }}"
    state: absent
  loop:
    - "{{ spec_schema }}.policies"
    - "{{ spec_schema }}.placementrules"
    - "{{ spec_schema }}.placementbindings"
    - "{{ status_schema }}.{{ managed_clusters_table }}"
    - "{{ status_schema }}.{{ policies_table }}"
    - "{{ status_schema }}.{{ aggregated_policies_table }}"
  loop_control:
    loop_var: table_name
  become: yes
  become_user: postgres

- name: delete types
  tags: tables
  postgresql_query:
    db: "{{ hoh_db }}"
    query: DROP TYPE {{ spec_schema}}.{{ enforcement_type }}
  become: yes
  become_user: postgres

- name: Stop service postgresql, if started
  service:
    name: postgresql
    state: stopped
  ignore_errors: yes

- name: uninstall postgresql
  apt:
    name:
      - postgresql
      - postgresql-client-common
      - postgresql-common
      - "postgresql-{{ postgresql_version }}"
      - "postgresql-client-{{ postgresql_version }}"
      - postgresql-contrib
      - libpq-dev
    state: absent
    purge: yes

- name: Delete postgresql directories
  file:
    state: absent
    path: '{{ item }}'
  loop:
    - /var/lib/postgresql
    - /var/log/postgresql
    - /etc/postgresql

- name: Remove the user postgres
  user:
    name: postgres
    state: absent
    remove: yes

- name: remove dependencies for ansible postgres
  pip:
    name:
      - psycopg2
    executable: pip3
    state: absent

- name: uninstall dependencies for ansible pip
  apt:
    name:
      - python3-pip
      - virtualenv
      - python-setuptools
    update_cache: yes
    state: absent
