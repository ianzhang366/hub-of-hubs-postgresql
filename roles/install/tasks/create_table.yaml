---
- debug:
    msg: creating table {{ name }} schema {{ schema }} database {{ database }}

- name: create table {{ name }}
  postgresql_table:
    name: "{{ schema }}.{{ name }}"
    db: "{{ database }}"
    columns:
      - id serial primary key
      - payload jsonb
      - created_at timestamp not null default now()
      - updated_at timestamp not null default now()
  become: yes
  become_user: postgres

  # based on https://x-team.com/blog/automatic-timestamps-with-postgresql/
- name: create set_timestamp trigger
  postgresql_query:
    db: "{{ hoh_db }}"
    query: |
      CREATE TRIGGER set_timestamp
      BEFORE UPDATE ON {{ schema }}.{{ name }}
      FOR EACH ROW
      EXECUTE PROCEDURE trigger_set_timestamp();
  become: yes
  become_user: postgres
